name: Build and Release

# å½“æ¨é€tagæ—¶è§¦å‘
on:
  push:
    tags:
      - 'v*'  # åŒ¹é…æ‰€æœ‰ä»¥vå¼€å¤´çš„æ ‡ç­¾

jobs:
  build-and-release:
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸš€ æ£€å‡ºä»£ç 
      uses: actions/checkout@v4
      
    - name: ğŸ“¦ è®¾ç½® Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '22'
        cache: 'npm'
        
    - name: ğŸ“¥ å®‰è£…ä¾èµ–
      run: |
        echo "ğŸ“¦ å®‰è£…é¡¹ç›®ä¾èµ–..."
        npm install
        
    - name: ğŸ”¨ æ„å»ºåº”ç”¨
      run: |
        echo "ğŸ”¨ å¼€å§‹æ„å»ºåº”ç”¨..."
        BODY_SIZE_LIMIT=4G npm run build
        echo "âœ… æ„å»ºå®Œæˆ"
        
    - name: ğŸ“ å‡†å¤‡å‘å¸ƒæ–‡ä»¶
      run: |
        echo "ğŸ“ å‡†å¤‡å‘å¸ƒæ–‡ä»¶..."
        
        # åˆ›å»ºå‘å¸ƒç›®å½•
        mkdir -p release
        
        # å¤åˆ¶æ„å»ºæ–‡ä»¶
        cp -r build/* release/

        # å¤åˆ¶å¿…è¦æ–‡ä»¶
        cp package.json release/
        cp package-lock.json release/
        cp README.md release/
        cp start.sh release/
        cp start.bat release/
        cp start.ps1 release/
        cp ecosystem.config.js release/
        cp nginx.conf release/
        cp Dockerfile release/
        cp docker-compose.yml release/
        
        # è®¾ç½®è„šæœ¬æ‰§è¡Œæƒé™
        chmod +x release/start.sh

        # åœ¨releaseç›®å½•å®‰è£…ç”Ÿäº§ä¾èµ–
        cd release && npm ci --omit dev && cd ..
        
        echo "ğŸ“Š å‘å¸ƒæ–‡ä»¶åˆ—è¡¨:"
        ls -la release/
        
    - name: ğŸ“¦ åˆ›å»ºå‘å¸ƒåŒ…
      run: |
        echo "ğŸ“¦ åˆ›å»ºå‘å¸ƒåŒ…..."
        cd release
        zip -r ../simple-drive-${{ github.ref_name }}.zip .
        cd ..
        
        echo "ğŸ“Š å‘å¸ƒåŒ…ä¿¡æ¯:"
        ls -lh simple-drive-${{ github.ref_name }}.zip
        
    - name: ğŸ·ï¸ åˆ›å»º GitHub Release
      uses: softprops/action-gh-release@v1
      with:
        files: simple-drive-${{ github.ref_name }}.zip
        name: Simple Drive ${{ github.ref_name }}
        body: |
          ## ğŸ‰ Simple Drive ${{ github.ref_name }}
          
          ### ğŸ“¦ å‘å¸ƒå†…å®¹
          - âœ… æ„å»ºå¥½çš„åº”ç”¨ç¨‹åº
          - âœ… Windows å¯åŠ¨è„šæœ¬ (start.bat)
          - âœ… Linux/macOS å¯åŠ¨è„šæœ¬ (start.sh)
          - âœ… PM2 é…ç½®æ–‡ä»¶
          - âœ… Nginx é…ç½®
          - âœ… Docker ç›¸å…³æ–‡ä»¶
          - âœ… ä½¿ç”¨è¯´æ˜æ–‡æ¡£
          
          ### ğŸš€ å¿«é€Ÿå¼€å§‹
          
          **Windows:**
          ```cmd
          start.bat
          ```
          
          **Linux/macOS:**
          ```bash
          chmod +x start.sh
          ./start.sh
          ```
          
          **ä½¿ç”¨ PM2:**
          ```bash
          npm install -g pm2
          pm2 start ecosystem.config.js
          ```
          
          **ä½¿ç”¨ Docker:**
          ```bash
          docker-compose up -d
          ```
          
          ### ğŸ“ æ–‡ä»¶ç»“æ„
          ```
          simple-drive-${{ github.ref_name }}/
          â”œâ”€â”€ build/              # æ„å»ºåçš„åº”ç”¨æ–‡ä»¶
          â”œâ”€â”€ uploads/            # ä¸Šä¼ æ–‡ä»¶ç›®å½•
          â”œâ”€â”€ start.sh            # Linux/macOS å¯åŠ¨è„šæœ¬
          â”œâ”€â”€ start.bat           # Windows å¯åŠ¨è„šæœ¬
          â”œâ”€â”€ start.ps1           # PowerShell å¯åŠ¨è„šæœ¬
          â”œâ”€â”€ package.json        # é¡¹ç›®é…ç½®
          â”œâ”€â”€ ecosystem.config.js # PM2 é…ç½®
          â”œâ”€â”€ nginx.conf          # Nginx é…ç½®
          â”œâ”€â”€ Dockerfile          # Docker é…ç½®
          â”œâ”€â”€ docker-compose.yml  # Docker Compose é…ç½®
          â””â”€â”€ README.md           # ä½¿ç”¨è¯´æ˜
          ```
          
          ### ğŸ”§ ç³»ç»Ÿè¦æ±‚
          - Node.js 22+ 
          - npm æˆ– yarn
          - æ”¯æŒçš„æ“ä½œç³»ç»Ÿ: Windows, Linux, macOS
        draft: false
        prerelease: false
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
